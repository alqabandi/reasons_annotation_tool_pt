<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta de Anota√ß√£o de Textos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #faf9f7;
            --bg-secondary: #ffffff;
            --bg-accent: #f0eeeb;
            --text-primary: #1a1a1a;
            --text-secondary: #5a5a5a;
            --text-muted: #8a8a8a;
            --accent-primary: #2d5a4a;
            --accent-secondary: #4a8b7a;
            --accent-light: #e8f0ed;
            --border: #e0ddd8;
            --shadow: rgba(0, 0, 0, 0.06);
            --success: #3d8b6e;
            --warning: #c4943d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-primary);
            letter-spacing: -0.02em;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-bar-wrapper {
            width: 200px;
            height: 8px;
            background: var(--bg-accent);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .annotator-badge {
            background: var(--accent-light);
            color: var(--accent-primary);
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Main Layout */
        .main-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Setup Screen */
        .setup-screen {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 4px 24px var(--shadow);
            text-align: center;
            margin-top: 4rem;
        }

        .setup-screen h1 {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }

        .setup-screen p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .setup-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-accent);
        }

        .file-upload:hover {
            border-color: var(--accent-secondary);
            background: var(--accent-light);
        }

        .file-upload.dragover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }

        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .file-upload-text {
            color: var(--text-secondary);
        }

        .file-upload input {
            display: none;
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 90, 74, 0.3);
        }

        .btn-primary:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-accent);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Annotation Screen */
        .annotation-screen {
            display: none;
        }

        .text-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 24px var(--shadow);
            position: sticky;
            top: 80px;
            z-index: 50;
            max-height: 320px;
            overflow-y: auto;
        }

        /* Instructions Panel */
        .instructions-toggle {
            background: var(--accent-light);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .instructions-toggle:hover {
            background: var(--accent-secondary);
            color: white;
        }

        .instructions-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            padding: 2rem;
            overflow-y: auto;
        }

        .instructions-panel.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .instructions-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .instructions-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--bg-accent);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .instructions-close:hover {
            background: var(--border);
        }

        .instructions-content h2 {
            font-family: 'Crimson Pro', Georgia, serif;
            color: var(--accent-primary);
            margin-bottom: 1.5rem;
        }

        .instructions-content h3 {
            color: var(--accent-primary);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .instructions-content p, .instructions-content li {
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            line-height: 1.7;
        }

        .instructions-content ul {
            padding-left: 1.5rem;
        }

        /* Button variations for resume state */
        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }

        .text-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .text-meta {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .text-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .statement-tag {
            display: inline-block;
            background: var(--accent-light);
            color: var(--accent-primary);
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .response-id {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: 'Courier New', monospace;
            text-align: right;
        }

        .text-content {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.35rem;
            line-height: 1.8;
            color: var(--text-primary);
        }

        /* Question Sections */
        .question-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 24px var(--shadow);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .section-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .section-icon.emotions { background: #fef3e2; }
        .section-icon.sentiment { background: #e8f4fd; }
        .section-icon.moral { background: #f3e8fd; }
        .section-icon.political { background: #e8fdf3; }

        .section-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .question {
            margin-bottom: 1.5rem;
        }

        .question:last-child {
            margin-bottom: 0;
        }

        .question-text {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .question-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-style: italic;
        }

        /* Skip banner */
        .skip-banner {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .skip-banner-left {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .skip-banner-title {
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .skip-banner-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .skip-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .skip-reason-select {
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
        }

        .skip-reason-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .btn-skip {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            border: 2px solid #c4943d;
            background: #fff8eb;
            color: #8a6b20;
            transition: all 0.2s;
        }

        .btn-skip:hover {
            background: #c4943d;
            color: white;
        }

        /* Skipped state */
        .skip-active-banner {
            background: #fff3cd;
            border: 2px solid #c4943d;
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .skip-active-banner.show {
            display: flex;
        }

        .skip-active-text {
            font-weight: 500;
            color: #8a6b20;
        }

        .btn-unskip {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            border: 2px solid var(--accent-primary);
            background: var(--accent-light);
            color: var(--accent-primary);
            transition: all 0.2s;
        }

        .btn-unskip:hover {
            background: var(--accent-primary);
            color: white;
        }

        .annotation-questions.hidden-by-skip {
            opacity: 0.25;
            pointer-events: none;
            filter: grayscale(0.5);
            transition: all 0.3s;
        }

        /* Open-ended text input */
        .open-ended-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: var(--bg-secondary);
        }

        .open-ended-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .question.error .open-ended-input {
            border-color: #e8b4b4;
        }

        /* Radio Options */
        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .option-btn {
            padding: 0.625rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .option-btn:hover {
            border-color: var(--accent-secondary);
            background: var(--accent-light);
        }

        .option-btn.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        .option-btn input {
            display: none;
        }

        /* Likert Scale */
        .likert-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .likert-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0 0.25rem;
        }

        .likert-scale {
            display: flex;
            gap: 0.35rem;
        }

        .likert-btn {
            flex: 1;
            padding: 0.4rem 0;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .likert-btn:hover {
            border-color: var(--accent-secondary);
            background: var(--accent-light);
        }

        .likert-btn.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        /* Emotion Matrix */
        .emotion-matrix {
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .emotion-matrix .matrix-header {
            display: flex;
            align-items: flex-end;
            padding: 0.6rem 0 0.3rem;
            background: var(--bg-accent);
        }

        .emotion-matrix .matrix-label-col {
            width: 110px;
            min-width: 110px;
            flex-shrink: 0;
        }

        .emotion-matrix .matrix-scale-col {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 0 0.5rem;
            gap: 0.1rem;
        }

        .emotion-matrix .matrix-endpoints {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 0 0.25rem;
        }

        .emotion-matrix .matrix-numbers {
            display: flex;
        }

        .emotion-matrix .matrix-numbers span {
            flex: 1;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .emotion-matrix .matrix-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 0.35rem 0;
            margin-bottom: 0;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .emotion-matrix .matrix-row:nth-child(odd) {
            background: rgba(0,0,0,0.015);
        }

        .emotion-matrix .matrix-label {
            width: 110px;
            min-width: 110px;
            flex-shrink: 0;
            font-weight: 500;
            font-size: 0.88rem;
            padding-left: 0.75rem;
            color: var(--text-primary);
        }

        .emotion-matrix .likert-scale {
            flex: 1;
            padding: 0 0.5rem;
            gap: 0.2rem;
        }

        .emotion-matrix .likert-btn {
            flex: 1;
            height: 28px;
            padding: 0;
            border-width: 1.5px;
            border-radius: 50%;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 36px;
            margin: 0 auto;
        }

        .emotion-matrix .validation-error {
            width: 100%;
            padding-left: 110px;
            margin-top: 0;
            font-size: 0.75rem;
        }

        .emotion-matrix .question.error .matrix-label {
            color: #c45a5a;
        }

        /* Yes/No Toggle */
        .yesno-container {
            display: flex;
            gap: 0.5rem;
        }

        .yesno-btn {
            padding: 0.625rem 1.5rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: inherit;
        }

        .yesno-btn:hover {
            border-color: var(--accent-secondary);
        }

        .yesno-btn.selected.yes {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .yesno-btn.selected.no {
            border-color: #c45a5a;
            background: #c45a5a;
            color: white;
        }

        /* Moral Foundations Grid */
        .moral-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .moral-item {
            background: var(--bg-accent);
            border-radius: 12px;
            padding: 1rem 1.25rem;
        }

        .moral-item .question-text {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .moral-definition {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-style: italic;
        }

        /* Navigation */
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .nav-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .nav-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .nav-jump {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .nav-jump input {
            width: 60px;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: inherit;
        }

        .nav-jump button {
            padding: 0.25rem 0.5rem;
            background: var(--bg-accent);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .nav-buttons {
            display: flex;
            gap: 0.75rem;
        }

        /* Complete Screen */
        .complete-screen {
            display: none;
            text-align: center;
            padding: 4rem 2rem;
        }

        .complete-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }

        .complete-screen h2 {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 2rem;
            color: var(--accent-primary);
            margin-bottom: 1rem;
        }

        .complete-screen p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--accent-primary);
            color: white;
            padding: 0.875rem 1.25rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .main-container {
                padding: 1rem;
            }

            .text-card, .question-section {
                padding: 1.5rem;
            }

            .moral-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }

        /* Validation error */
        .validation-error {
            color: #c45a5a;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        .question.error .validation-error {
            display: block;
        }

        .question.error .options-grid .option-btn,
        .question.error .likert-btn,
        .question.error .yesno-btn {
            border-color: #e8b4b4;
        }

        /* Incomplete indicator */
        .incomplete-badge {
            background: var(--warning);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Existing sessions */
        .existing-sessions {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .existing-sessions-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .session-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            background: var(--accent-light);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .session-card:hover {
            border-color: var(--accent-secondary);
            background: white;
        }

        .session-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .session-username {
            font-weight: 600;
            color: var(--accent-primary);
            font-size: 0.95rem;
        }

        .session-progress {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .session-resume-label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--accent-secondary);
        }

        /* Confirmation overlay */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            justify-content: center;
            align-items: center;
        }

        .confirm-overlay.show {
            display: flex;
        }

        .confirm-box {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 440px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .confirm-box h3 {
            color: #c45a5a;
            margin-bottom: 0.75rem;
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.3rem;
        }

        .confirm-box p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .confirm-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">üìù Ferramenta de Anota√ß√£o</div>
            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="progressText">0 / 0</span>
            </div>
            <button class="instructions-toggle" id="instructionsBtn">
                üìñ Instru√ß√µes
            </button>
            <div class="annotator-badge" id="annotatorBadge" style="display: none;">
                Anotador: <span id="annotatorDisplay"></span>
            </div>
        </div>
    </header>

    <!-- Instructions Panel -->
    <div class="instructions-panel" id="instructionsPanel">
        <div class="instructions-content">
            <button class="instructions-close" id="instructionsClose">√ó</button>
            <h2>üìñ Instru√ß√µes de Anota√ß√£o</h2>
            
            <h3>Vis√£o Geral</h3>
            <p>Voc√™ ler√° respostas curtas de texto e as anotar√° com base em emo√ß√£o, sentimento, fundamentos morais e infer√™ncia pol√≠tica.</p>
            
            <h3>Como Usar Esta Ferramenta</h3>
            <ul>
                <li><strong>Digite seu nome de usu√°rio</strong> na tela inicial ‚Äî isso cria seu arquivo pessoal de anota√ß√µes</li>
                <li><strong>Leia cada texto com aten√ß√£o</strong> antes de responder √†s perguntas</li>
                <li><strong>Responda todas as perguntas</strong> de cada texto antes de clicar em "Salvar & Pr√≥ximo"</li>
                <li><strong>Seu progresso √© salvo automaticamente</strong> ap√≥s cada anota√ß√£o</li>
                <li>Voc√™ pode <strong>fechar o navegador e continuar depois</strong> ‚Äî basta digitar o mesmo nome de usu√°rio</li>
            </ul>
            
            <h3>Categorias de Anota√ß√£o</h3>
            
            <h4 style="color: var(--text-primary); margin-top: 1rem;">üòä Emo√ß√µes</h4>
            <ul>
                <li><strong>Intensidade da Emo√ß√£o:</strong> Avalie o quanto de cada emo√ß√£o (ansiedade, tristeza, raiva, alegria, otimismo, frustra√ß√£o, medo, esperan√ßa) est√° presente em uma escala de 1 a 7</li>
            </ul>
            
            <h4 style="color: var(--text-primary); margin-top: 1rem;">üí≠ Sentimento</h4>
            <ul>
                <li><strong>Categoria do Sentimento:</strong> O sentimento geral √© Positivo, Neutro ou Negativo?</li>
                <li><strong>Escala de Sentimento:</strong> Avalie de 1 (muito negativo) a 7 (muito positivo)</li>
            </ul>
            
            <h4 style="color: var(--text-primary); margin-top: 1rem;">‚öñÔ∏è Fundamentos Morais</h4>
            <p>Voc√™ responder√° duas perguntas sobre fundamentos morais:</p>
            <ul>
                <li><strong>Fundamento Mais Representativo:</strong> Escolha o √∫nico fundamento moral que melhor representa o texto. Op√ß√µes:</li>
            </ul>
            <ul style="padding-left: 3rem; margin-top: -0.5rem;">
                <li><strong>Cuidado:</strong> Compaix√£o, bondade e preocupa√ß√£o com o sofrimento alheio</li>
                <li><strong>Justi√ßa:</strong> Coopera√ß√£o, confiabilidade e tratamento igualit√°rio</li>
                <li><strong>Autoridade:</strong> Defer√™ncia a autoridades leg√≠timas e respeito √† tradi√ß√£o</li>
                <li><strong>Lealdade:</strong> Fidelidade ao grupo, fam√≠lia ou na√ß√£o; n√£o trair os outros</li>
                <li><strong>Pureza:</strong> Evitar repugn√¢ncia, contamina√ß√£o; manter limpeza e santidade</li>
                <li><strong>Liberdade:</strong> Liberdade individual, autonomia e resist√™ncia √† domina√ß√£o</li>
                <li><strong>Honestidade:</strong> Ser verdadeiro, sincero e transparente</li>
                <li><strong>Autodisciplina:</strong> Persist√™ncia, autocontrole e resist√™ncia √† tenta√ß√£o</li>
                <li><strong>N√£o tenho certeza / Nenhum</strong></li>
            </ul>
            <ul>
                <li><strong>Orienta√ß√£o do Fundamento Moral:</strong> O texto enfatiza valores <em>individualizantes</em> (direitos individuais, cuidado, justi√ßa), valores <em>vinculantes</em> (coes√£o grupal, lealdade, autoridade, pureza), <em>nenhum</em>, ou <em>n√£o √© poss√≠vel determinar</em>?</li>
            </ul>
            
            <h4 style="color: var(--text-primary); margin-top: 1rem;">üó≥Ô∏è Infer√™ncia Pol√≠tica</h4>
            <p>Com base apenas no texto, com qual posi√ß√£o pol√≠tica voc√™ acha que o autor mais provavelmente se identifica? Selecione "N√£o √© poss√≠vel determinar" se n√£o houver informa√ß√£o suficiente.</p>
            
            <h3>Dicas</h3>
            <ul>
                <li>O texto que voc√™ est√° anotando permanece vis√≠vel no topo enquanto voc√™ navega</li>
                <li>Fa√ßa pausas se necess√°rio ‚Äî seu progresso est√° sempre salvo</li>
                <li>Se estiver em d√∫vida, use seu melhor julgamento</li>
            </ul>
        </div>
    </div>

    <!-- Setup Screen -->
    <main class="main-container">
        <div class="setup-screen" id="setupScreen">
            <h1>Bem-vindo(a), Anotador(a)!</h1>
            <p>Digite seu nome de usu√°rio para come√ßar a anotar. Seu progresso √© salvo automaticamente ap√≥s cada anota√ß√£o em seu arquivo pessoal.</p>
            
            <div class="setup-form">
                <div class="form-group">
                    <label for="annotatorId">Seu Nome de Usu√°rio</label>
                    <input type="text" id="annotatorId" placeholder="ex.: joao_silva">
                    <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                        Suas anota√ß√µes ser√£o salvas em: <strong id="filenamePreview">annotations_[usuario].csv</strong>
                    </small>
                </div>
                
                <div id="dataStatus" style="padding: 1rem; background: var(--bg-accent); border-radius: 8px; margin-bottom: 1rem;">
                    <span id="loadingStatus">Carregando dados...</span>
                </div>

                <div id="existingSessions" class="existing-sessions" style="display: none;">
                    <div class="existing-sessions-label">Sess√µes existentes encontradas neste computador</div>
                    <div id="sessionsList"></div>
                </div>

                <div id="buttonContainer">
                    <button class="btn btn-primary btn-large" id="resumeBtn" style="display: none; width: 100%; margin-bottom: 0.75rem;">Retomar Sess√£o Anterior</button>
                    <button class="btn btn-primary" id="startBtn" disabled style="width: 100%;">Come√ßar a Anotar</button>
                </div>
            </div>
        </div>

        <!-- Annotation Screen -->
        <div class="annotation-screen" id="annotationScreen">
            <!-- Text Display -->
            <div class="text-card fade-in">
                <div class="context-box" id="contextBox" style="background: var(--bg-accent); padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                    <div style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Contexto: O participante foi questionado sobre a seguinte afirma√ß√£o</div>
                    <div id="statementText" style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem;"></div>
                    <div id="agreeText" style="display: inline-block; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;"></div>
                </div>
                <div class="text-label" style="margin-bottom: 0.5rem;">Resposta do Participante</div>
                <div class="text-content" id="textContent"></div>
            </div>

            <!-- Skip Banner -->
            <div class="skip-banner" id="skipBanner">
                <div class="skip-banner-left">
                    <div class="skip-banner-title">N√£o consegue anotar este texto?</div>
                    <div class="skip-banner-hint">Use isto se a resposta for sem sentido, em branco, em outro idioma, etc.</div>
                </div>
                <div class="skip-controls">
                    <select class="skip-reason-select" id="skipReason">
                        <option value="">Motivo‚Ä¶</option>
                        <option value="gibberish">Texto sem sentido</option>
                        <option value="blank">Em branco / vazio</option>
                        <option value="other_language">Idioma diferente</option>
                        <option value="unclear">Confuso / ininterpret√°vel</option>
                        <option value="other">Outro</option>
                    </select>
                    <button class="btn-skip" id="skipBtn">Pular & Pr√≥ximo ‚Üí</button>
                </div>
            </div>

            <!-- Skipped state banner (shown when navigating back to a skipped item) -->
            <div class="skip-active-banner" id="skipActiveBanner">
                <div class="skip-active-text">‚ö† Este item foi pulado ‚Äî <span id="skipActiveReason"></span></div>
                <button class="btn-unskip" id="unskipBtn">Desfazer e anotar</button>
            </div>

            <div class="annotation-questions" id="annotationQuestions">
            <!-- Emotions Section -->
            <div class="question-section fade-in" style="animation-delay: 0.1s;">
                <div class="section-header">
                    <div class="section-icon emotions">üòä</div>
                    <h2 class="section-title">Emo√ß√µes</h2>
                </div>

                <div class="question-text" style="margin-bottom: 0.75rem;">Quanto de cada emo√ß√£o est√° presente neste texto?</div>
                <div class="emotion-matrix">
                    <div class="matrix-header">
                        <div class="matrix-label-col"></div>
                        <div class="matrix-scale-col">
                            <div class="matrix-endpoints">
                                <span>Nenhuma</span>
                                <span>Muita</span>
                            </div>
                            <div class="matrix-numbers">
                                <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span>
                            </div>
                        </div>
                    </div>

                    <div class="matrix-row question" data-field="emotion_anxiety_likert">
                        <div class="matrix-label">Ansiedade</div>
                        <div class="likert-scale">
                            <button class="likert-btn" data-value="1">1</button>
                            <button class="likert-btn" data-value="2">2</button>
                            <button class="likert-btn" data-value="3">3</button>
                            <button class="likert-btn" data-value="4">4</button>
                            <button class="likert-btn" data-value="5">5</button>
                            <button class="likert-btn" data-value="6">6</button>
                            <button class="likert-btn" data-value="7">7</button>
                        </div>
                        <div class="validation-error">Por favor, selecione um valor</div>
                    </div>

                    <div class="matrix-row question" data-field="emotion_anger_likert">
                        <div class="matrix-label">Raiva</div>
                        <div class="likert-scale">
                            <button class="likert-btn" data-value="1">1</button>
                            <button class="likert-btn" data-value="2">2</button>
                            <button class="likert-btn" data-value="3">3</button>
                            <button class="likert-btn" data-value="4">4</button>
                            <button class="likert-btn" data-value="5">5</button>
                            <button class="likert-btn" data-value="6">6</button>
                            <button class="likert-btn" data-value="7">7</button>
                        </div>
                        <div class="validation-error">Por favor, selecione um valor</div>
                    </div>

                    <div class="matrix-row question" data-field="emotion_sadness_likert">
                        <div class="matrix-label">Tristeza</div>
                        <div class="likert-scale">
                            <button class="likert-btn" data-value="1">1</button>
                            <button class="likert-btn" data-value="2">2</button>
                            <button class="likert-btn" data-value="3">3</button>
                            <button class="likert-btn" data-value="4">4</button>
                            <button class="likert-btn" data-value="5">5</button>
                            <button class="likert-btn" data-value="6">6</button>
                            <button class="likert-btn" data-value="7">7</button>
                        </div>
                        <div class="validation-error">Por favor, selecione um valor</div>
                    </div>

                    <div class="matrix-row question" data-field="emotion_joy_likert">
                        <div class="matrix-label">Alegria</div>
                        <div class="likert-scale">
                            <button class="likert-btn" data-value="1">1</button>
                            <button class="likert-btn" data-value="2">2</button>
                            <button class="likert-btn" data-value="3">3</button>
                            <button class="likert-btn" data-value="4">4</button>
                            <button class="likert-btn" data-value="5">5</button>
                            <button class="likert-btn" data-value="6">6</button>
                            <button class="likert-btn" data-value="7">7</button>
                        </div>
                        <div class="validation-error">Por favor, selecione um valor</div>
                    </div>

                    <div class="matrix-row question" data-field="emotion_optimism_likert">
                        <div class="matrix-label">Otimismo</div>
                        <div class="likert-scale">
                            <button class="likert-btn" data-value="1">1</button>
                            <button class="likert-btn" data-value="2">2</button>
                            <button class="likert-btn" data-value="3">3</button>
                            <button class="likert-btn" data-value="4">4</button>
                            <button class="likert-btn" data-value="5">5</button>
                            <button class="likert-btn" data-value="6">6</button>
                            <button class="likert-btn" data-value="7">7</button>
                        </div>
                        <div class="validation-error">Por favor, selecione um valor</div>
                    </div>

                    <div class="matrix-row question" data-field="emotion_frustration_likert">
                        <div class="matrix-label">Frustra√ß√£o</div>
                        <div class="likert-scale">
                            <button class="likert-btn" data-value="1">1</button>
                            <button class="likert-btn" data-value="2">2</button>
                            <button class="likert-btn" data-value="3">3</button>
                            <button class="likert-btn" data-value="4">4</button>
                            <button class="likert-btn" data-value="5">5</button>
                            <button class="likert-btn" data-value="6">6</button>
                            <button class="likert-btn" data-value="7">7</button>
                        </div>
                        <div class="validation-error">Por favor, selecione um valor</div>
                    </div>

                    <div class="matrix-row question" data-field="emotion_fear_likert">
                        <div class="matrix-label">Medo</div>
                        <div class="likert-scale">
                            <button class="likert-btn" data-value="1">1</button>
                            <button class="likert-btn" data-value="2">2</button>
                            <button class="likert-btn" data-value="3">3</button>
                            <button class="likert-btn" data-value="4">4</button>
                            <button class="likert-btn" data-value="5">5</button>
                            <button class="likert-btn" data-value="6">6</button>
                            <button class="likert-btn" data-value="7">7</button>
                        </div>
                        <div class="validation-error">Por favor, selecione um valor</div>
                    </div>

                    <div class="matrix-row question" data-field="emotion_hope_likert">
                        <div class="matrix-label">Esperan√ßa</div>
                        <div class="likert-scale">
                            <button class="likert-btn" data-value="1">1</button>
                            <button class="likert-btn" data-value="2">2</button>
                            <button class="likert-btn" data-value="3">3</button>
                            <button class="likert-btn" data-value="4">4</button>
                            <button class="likert-btn" data-value="5">5</button>
                            <button class="likert-btn" data-value="6">6</button>
                            <button class="likert-btn" data-value="7">7</button>
                        </div>
                        <div class="validation-error">Por favor, selecione um valor</div>
                    </div>
                </div>
            </div>

            <!-- Sentiment Section -->
            <div class="question-section fade-in" style="animation-delay: 0.2s;">
                <div class="section-header">
                    <div class="section-icon sentiment">üí≠</div>
                    <h2 class="section-title">Sentimento</h2>
                </div>

                <div class="question" data-field="sentiment_categorical">
                    <div class="question-text">O sentimento deste texto √© positivo, neutro ou negativo?</div>
                    <div class="options-grid">
                        <label class="option-btn"><input type="radio" name="sentiment_categorical" value="1">Positivo</label>
                        <label class="option-btn"><input type="radio" name="sentiment_categorical" value="2">Neutro</label>
                        <label class="option-btn"><input type="radio" name="sentiment_categorical" value="3">Negativo</label>
                    </div>
                    <div class="validation-error">Por favor, selecione uma op√ß√£o</div>
                </div>

                <div class="question" data-field="sentiment_likert">
                    <div class="question-text">Qu√£o negativo ou positivo √© este texto?</div>
                    <div class="likert-container">
                        <div class="likert-labels">
                            <span>Muito negativo</span>
                            <span>Muito positivo</span>
                        </div>
                        <div class="likert-scale">
                            <button class="likert-btn" data-value="1">1</button>
                            <button class="likert-btn" data-value="2">2</button>
                            <button class="likert-btn" data-value="3">3</button>
                            <button class="likert-btn" data-value="4">4</button>
                            <button class="likert-btn" data-value="5">5</button>
                            <button class="likert-btn" data-value="6">6</button>
                            <button class="likert-btn" data-value="7">7</button>
                        </div>
                    </div>
                    <div class="validation-error">Por favor, selecione um valor</div>
                </div>
            </div>

            <!-- Moral Foundations Section -->
            <div class="question-section fade-in" style="animation-delay: 0.3s;">
                <div class="section-header">
                    <div class="section-icon moral">‚öñÔ∏è</div>
                    <h2 class="section-title">Fundamentos Morais</h2>
                </div>

                <div class="question" data-field="mf_best">
                    <div class="question-text">Qual <strong>fundamento moral</strong> melhor representa este texto?</div>
                    <div class="question-hint">Escolha o fundamento que melhor se encaixa. Consulte o painel de Instru√ß√µes para defini√ß√µes.</div>
                    <div class="options-grid">
                        <label class="option-btn"><input type="radio" name="mf_best" value="1">Cuidado</label>
                        <label class="option-btn"><input type="radio" name="mf_best" value="2">Justi√ßa</label>
                        <label class="option-btn"><input type="radio" name="mf_best" value="3">Autoridade</label>
                        <label class="option-btn"><input type="radio" name="mf_best" value="4">Lealdade</label>
                        <label class="option-btn"><input type="radio" name="mf_best" value="5">Pureza</label>
                        <label class="option-btn"><input type="radio" name="mf_best" value="6">Liberdade</label>
                        <label class="option-btn"><input type="radio" name="mf_best" value="7">Honestidade</label>
                        <label class="option-btn"><input type="radio" name="mf_best" value="8">Autodisciplina</label>
                        <label class="option-btn"><input type="radio" name="mf_best" value="9">N√£o tenho certeza</label>
                        <label class="option-btn"><input type="radio" name="mf_best" value="0">Nenhum</label>
                    </div>
                    <div class="validation-error">Por favor, selecione uma op√ß√£o</div>
                </div>

                <div class="question" data-field="mf_orientation" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <div class="question-text">Qual <strong>orienta√ß√£o de fundamento moral</strong> este texto mais expressa?</div>
                    <div class="question-hint">Individualizante = direitos individuais independente do grupo (cuidado, justi√ßa). Vinculante = coes√£o grupal (lealdade, autoridade, pureza).</div>
                    <div class="options-grid">
                        <label class="option-btn"><input type="radio" name="mf_orientation" value="1">Individualizante</label>
                        <label class="option-btn"><input type="radio" name="mf_orientation" value="2">Vinculante</label>
                        <label class="option-btn"><input type="radio" name="mf_orientation" value="3">Nenhuma</label>
                        <label class="option-btn"><input type="radio" name="mf_orientation" value="0">N√£o √© poss√≠vel determinar</label>
                    </div>
                    <div class="validation-error">Por favor, selecione uma op√ß√£o</div>
                </div>
            </div>

            <!-- Political Guess Section -->
            <div class="question-section fade-in" style="animation-delay: 0.4s;">
                <div class="section-header">
                    <div class="section-icon political">üó≥Ô∏è</div>
                    <h2 class="section-title">Infer√™ncia Pol√≠tica</h2>
                </div>

                <div class="question" data-field="political_guess">
                    <div class="question-text">Com base neste texto, com qual posi√ß√£o pol√≠tica voc√™ acha que o autor mais provavelmente se identifica?</div>
                    <div class="options-grid">
                        <label class="option-btn"><input type="radio" name="political_guess" value="1">Esquerda</label>
                        <label class="option-btn"><input type="radio" name="political_guess" value="2">Direita</label>
                        <label class="option-btn"><input type="radio" name="political_guess" value="3">Centro/Outro</label>
                        <label class="option-btn"><input type="radio" name="political_guess" value="4">N√£o √© poss√≠vel determinar</label>
                    </div>
                    <div class="validation-error">Por favor, selecione uma op√ß√£o</div>
                </div>
            </div>

            </div><!-- /annotation-questions -->

            <!-- Navigation -->
            <div class="nav-container">
                <div class="nav-info">
                    <div class="nav-hint">
                        <span id="currentIndex">1</span> de <span id="totalItems">0</span> itens
                    </div>
                    <div class="nav-jump">
                        Ir para: <input type="number" id="jumpInput" min="1"> 
                        <button id="jumpBtn">Ir</button>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="btn btn-secondary" id="prevBtn">‚Üê Anterior</button>
                    <button class="btn btn-primary" id="nextBtn">Salvar & Pr√≥ximo ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Complete Screen -->
        <div class="complete-screen" id="completeScreen">
            <div class="complete-icon">üéâ</div>
            <h2>Tudo Pronto!</h2>
            <p>Voc√™ completou todas as anota√ß√µes. Obrigado(a) pelo seu trabalho!</p>
            <button class="btn btn-primary" id="downloadBtn">Baixar Anota√ß√µes (CSV)</button>
            <div style="margin-top: 1rem;">
                <button class="btn btn-secondary" id="reviewBtn">Revisar Anota√ß√µes</button>
            </div>
        </div>
    </main>

    <!-- Confirmation Dialog -->
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-box">
            <h3>Come√ßar do Zero?</h3>
            <p id="confirmMessage">Um arquivo de anota√ß√µes existente foi encontrado para este usu√°rio. Come√ßar do zero ir√° <strong>apagar todo o progresso anterior</strong>. Tem certeza?</p>
            <div class="confirm-buttons">
                <button class="btn btn-secondary" id="confirmCancel">Cancelar</button>
                <button class="btn btn-primary" id="confirmProceed" style="background: #c45a5a;">Sim, Come√ßar do Zero</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>


    <script>
        // ===== STATE =====
        let state = {
            annotatorId: '',
            data: [],
            annotations: {},  // keyed by unique row identifier (rowid value)
            currentIndex: 0,
            isComplete: false,
            serverMode: true  // Whether we're running with the Python server
        };

        const STORAGE_KEY = 'annotation_tool_state_v2';
        const API_BASE = '';  // Same origin

        // ===== DOM ELEMENTS =====
        const $ = id => document.getElementById(id);

        const elements = {
            setupScreen: $('setupScreen'),
            annotationScreen: $('annotationScreen'),
            completeScreen: $('completeScreen'),
            progressContainer: $('progressContainer'),
            progressBar: $('progressBar'),
            progressText: $('progressText'),
            annotatorBadge: $('annotatorBadge'),
            annotatorDisplay: $('annotatorDisplay'),
            annotatorId: $('annotatorId'),
            dataStatus: $('dataStatus'),
            loadingStatus: $('loadingStatus'),
            filenamePreview: $('filenamePreview'),
            startBtn: $('startBtn'),
            resumeBtn: $('resumeBtn'),
            buttonContainer: $('buttonContainer'),
            contextBox: $('contextBox'),
            statementText: $('statementText'),
            agreeText: $('agreeText'),
            textContent: $('textContent'),
            currentIndex: $('currentIndex'),
            totalItems: $('totalItems'),
            prevBtn: $('prevBtn'),
            nextBtn: $('nextBtn'),
            downloadBtn: $('downloadBtn'),
            reviewBtn: $('reviewBtn'),
            toast: $('toast'),
            jumpInput: $('jumpInput'),
            jumpBtn: $('jumpBtn'),
            instructionsBtn: $('instructionsBtn'),
            instructionsPanel: $('instructionsPanel'),
            instructionsClose: $('instructionsClose'),
            existingSessions: $('existingSessions'),
            sessionsList: $('sessionsList'),
            confirmOverlay: $('confirmOverlay'),
            confirmCancel: $('confirmCancel'),
            confirmProceed: $('confirmProceed'),
            skipBanner: $('skipBanner'),
            skipReason: $('skipReason'),
            skipBtn: $('skipBtn'),
            skipActiveBanner: $('skipActiveBanner'),
            skipActiveReason: $('skipActiveReason'),
            unskipBtn: $('unskipBtn'),
            annotationQuestions: $('annotationQuestions')
        };

        // ===== STATEMENT MAPPING =====
        const STATEMENT_MAP = {
            'gov_power': 'O Governo Federal tem muito poder.',
            'gov_regulation': 'A regula√ß√£o governamental do com√©rcio normalmente faz mais mal do que bem.',
            'gov_waste': 'O Governo √© sempre dispendioso e ineficiente.',
            'compromise': 'Autoridades eleitas devem manter suas posi√ß√µes em vez de fazer concess√µes.',
            'wealth_tax': 'Pessoas ricas n√£o pagam cota justa de impostos.',
            'environ_law': 'Nosso pa√≠s deveria ter menos leis e regulamenta√ß√µes ambientais.',
            'climate_change': 'Mudan√ßas clim√°ticas globais s√£o a maior amea√ßa ao mundo.',
            'gov_resp': 'O Governo tem a responsabilidade de ajudar todos os cidad√£os necessitados.',
            'gov_needy': 'O Governo deveria fazer mais para ajudar os necessitados.',
            'white_priv': 'Na sociedade, pessoas brancas t√™m vantagens que pessoas pretas n√£o t√™m.',
            'government_crime': 'O Governo deveria aprovar leis mais r√≠gidas para combater a criminalidade.',
            'police': 'A pol√≠cia faz um bom trabalho para deixar todos se sentirem seguros.',
            'immigrants': 'O Governo deveria permitir menos imigrantes no pa√≠s.',
            'immigrant_strength': 'Imigrantes fortalecem o pa√≠s com seu trabalho √°rduo e seus talentos.',
            'foreign_trade': 'O com√©rcio exterior √© uma oportunidade para o crescimento econ√¥mico.',
            'military_peace': 'A melhor forma de assegurar a paz √© pela for√ßa militar.',
            'military_priority': 'As For√ßas Armadas devem estar no topo das prioridades dos l√≠deres do pa√≠s.',
            'gun_laws': 'As leis armamentistas deveriam ser mais r√≠gidas.',
            'gun_database': 'Deveria existir um banco de dados nacional para rastrear as vendas de armas.',
            'public_ed': 'A educa√ß√£o b√°sica no Brasil √© satisfat√≥ria.',
            'school_impact': 'Escolas do ensino b√°sico t√™m efeito positivo no pa√≠s.',
            'transgender': 'As crian√ßas deveriam aprender que algu√©m pode ser um menino ou uma menina mesmo que, no nascimento, o sexo seja diferente.',
            'abortion': 'O Governo deveria permitir o aborto.',
            'unrestrict_abortion': 'O aborto deveria ser legalizado em qualquer circunst√¢ncia.',
            'health_abortion': 'Aborto deveria ser legalizado quando for prov√°vel o beb√™ nascer com defici√™ncias severas ou problemas de sa√∫de.',
            'misinformation': 'O Governo deveria fazer mais para combater a dissemina√ß√£o de desinforma√ß√£o nas m√≠dias sociais.',
            'social_media': 'Informa√ß√µes provenientes das m√≠dias sociais sobre eventos nacionais s√£o confi√°veis.',
            'homosexuality': 'A homossexualidade deveria ser desencorajada pela sociedade.',
            'marijuana': 'O uso da maconha deveria ser legalizado.',
            'msm': 'As principais organiza√ß√µes midi√°ticas s√£o confi√°veis.'
        };

        function getStatementText(code) {
            return STATEMENT_MAP[code] || code;
        }

        // ===== CSV PARSING =====
        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            if (lines.length < 2) throw new Error('CSV must have header and data rows');

            // Parse header
            const header = parseCSVLine(lines[0]);
            const rowidIdx = header.findIndex(h => h.toLowerCase() === 'rowid');
            const responseIdIdx = header.findIndex(h => h.toLowerCase() === 'responseid');
            const statementIdx = header.findIndex(h => h.toLowerCase() === 'statement');
            const agreeIdx = header.findIndex(h => h.toLowerCase() === 'agree');
            const describeIdx = header.findIndex(h => h.toLowerCase() === 'x_describe');

            if (rowidIdx === -1) throw new Error('CSV must have "rowid" column');
            if (responseIdIdx === -1) throw new Error('CSV must have "ResponseId" column');
            if (statementIdx === -1) throw new Error('CSV must have "statement" column');
            if (describeIdx === -1) throw new Error('CSV must have "X_describe" column');

            // Parse data rows
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                if (values.length < Math.max(rowidIdx, responseIdIdx, statementIdx, describeIdx) + 1) continue;
                
                data.push({
                    rowid: values[rowidIdx] || '',
                    ResponseId: values[responseIdIdx] || '',
                    statement: values[statementIdx] || '',
                    agree: agreeIdx !== -1 ? (values[agreeIdx] || '') : '',
                    X_describe: values[describeIdx] || ''
                });
            }

            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // ===== API FUNCTIONS =====
        async function apiLoadTemplate() {
            try {
                const response = await fetch(`${API_BASE}/api/template`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log('Server not available, falling back to local mode');
            }
            return null;
        }

        async function apiLoadUserAnnotations(username) {
            try {
                const response = await fetch(`${API_BASE}/api/annotations?username=${encodeURIComponent(username)}`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log('Could not load user annotations');
            }
            return null;
        }

        async function apiInitUser(username) {
            try {
                const response = await fetch(`${API_BASE}/api/init-user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log('Could not initialize user file');
            }
            return null;
        }

        async function apiSaveAnnotations() {
            if (!state.serverMode) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: state.annotatorId,
                        data: state.data,
                        annotations: state.annotations
                    })
                });
                if (response.ok) {
                    const result = await response.json();
                    return result;
                }
            } catch (e) {
                console.log('Could not save to server');
            }
            return null;
        }

        async function apiCheckUser(username) {
            try {
                const response = await fetch(`${API_BASE}/api/check-user?username=${encodeURIComponent(username)}`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log('Could not check user');
            }
            return null;
        }

        async function apiListUsers() {
            try {
                const response = await fetch(`${API_BASE}/api/list-users`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log('Could not list users');
            }
            return null;
        }

        // ===== STORAGE =====
        async function saveState() {
            // Save to localStorage as backup
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            
            // Also save to server if available
            if (state.serverMode) {
                const result = await apiSaveAnnotations();
                if (result && result.success) {
                    showToast(`Salvo em annotations_${state.annotatorId}.csv`);
                } else {
                    showToast('Progresso salvo localmente');
                }
            } else {
                showToast('Progresso salvo localmente');
            }
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                return JSON.parse(saved);
            }
            return null;
        }

        function clearState() {
            localStorage.removeItem(STORAGE_KEY);
        }

        // Get unique key for each row (using rowid since it's unique per row)
        function getRowKey(item) {
            return item.rowid;
        }

        // ===== UI FUNCTIONS =====
        function showToast(message) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            setTimeout(() => elements.toast.classList.remove('show'), 2000);
        }

        function updateProgress() {
            const completed = Object.keys(state.annotations).length;
            const total = state.data.length;
            const percent = total > 0 ? (completed / total) * 100 : 0;
            
            elements.progressBar.style.width = `${percent}%`;
            elements.progressText.textContent = `${completed} / ${total}`;
        }

        function showScreen(screen) {
            elements.setupScreen.style.display = 'none';
            elements.annotationScreen.style.display = 'none';
            elements.completeScreen.style.display = 'none';

            if (screen === 'setup') {
                elements.setupScreen.style.display = 'block';
                elements.progressContainer.style.display = 'none';
                elements.annotatorBadge.style.display = 'none';
            } else if (screen === 'annotation') {
                elements.annotationScreen.style.display = 'block';
                elements.progressContainer.style.display = 'flex';
                elements.annotatorBadge.style.display = 'block';
            } else if (screen === 'complete') {
                elements.completeScreen.style.display = 'block';
                elements.progressContainer.style.display = 'flex';
                elements.annotatorBadge.style.display = 'block';
            }
        }

        function loadItem(index) {
            if (index < 0 || index >= state.data.length) return;

            state.currentIndex = index;
            const item = state.data[index];
            const rowKey = getRowKey(item);

            // Update display
            elements.textContent.textContent = item.X_describe;
            elements.currentIndex.textContent = index + 1;
            
            // Update context display
            const statementFullText = getStatementText(item.statement);
            elements.statementText.textContent = `"${statementFullText}"`;
            
            // Style the agree badge based on opinion (Portuguese values)
            const agree = (item.agree || '').toLowerCase();
            elements.agreeText.textContent = item.agree || 'Desconhecido';
            if (agree === 'concordo') {
                elements.agreeText.style.background = '#d4edda';
                elements.agreeText.style.color = '#155724';
            } else if (agree === 'discordo') {
                elements.agreeText.style.background = '#f8d7da';
                elements.agreeText.style.color = '#721c24';
            } else {
                elements.agreeText.style.background = '#fff3cd';
                elements.agreeText.style.color = '#856404';
            }
            elements.totalItems.textContent = state.data.length;
            elements.jumpInput.max = state.data.length;
            elements.jumpInput.value = '';

            // Clear all selections
            document.querySelectorAll('.option-btn, .likert-btn, .yesno-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('input[type="radio"]').forEach(input => {
                input.checked = false;
            });
            document.querySelectorAll('.open-ended-input').forEach(input => {
                input.value = '';
            });
            document.querySelectorAll('.question').forEach(q => q.classList.remove('error'));

            // Load existing annotations if any
            const existing = state.annotations[rowKey];
            if (existing) {
                Object.entries(existing).forEach(([field, value]) => {
                    if (!value) return;

                    // Open-ended text inputs
                    const textInput = document.getElementById(`${field}_input`);
                    if (textInput) {
                        textInput.value = value;
                        return;
                    }
                    
                    // Radio buttons
                    const radio = document.querySelector(`input[name="${field}"][value="${value}"]`);
                    if (radio) {
                        radio.checked = true;
                        radio.closest('.option-btn')?.classList.add('selected');
                    }

                    // Likert buttons
                    const likertContainer = document.querySelector(`[data-field="${field}"] .likert-scale`);
                    if (likertContainer) {
                        const btn = likertContainer.querySelector(`[data-value="${value}"]`);
                        if (btn) btn.classList.add('selected');
                    }

                    // Yes/No buttons
                    const yesnoContainer = document.querySelector(`[data-field="${field}"] .yesno-container`);
                    if (yesnoContainer) {
                        const btn = yesnoContainer.querySelector(`[data-value="${value}"]`);
                        if (btn) btn.classList.add('selected');
                    }
                });
            }

            // Update nav buttons
            elements.prevBtn.disabled = index === 0;
            elements.nextBtn.textContent = index === state.data.length - 1 ? 'Finalizar ‚úì' : 'Salvar & Pr√≥ximo ‚Üí';

            // Handle skip state
            const isSkipped = existing && existing._skipped;
            if (isSkipped) {
                elements.skipBanner.style.display = 'none';
                elements.skipActiveBanner.classList.add('show');
                elements.skipActiveReason.textContent = existing.skip_reason || 'sem motivo informado';
                elements.annotationQuestions.classList.add('hidden-by-skip');
            } else {
                elements.skipBanner.style.display = 'flex';
                elements.skipActiveBanner.classList.remove('show');
                elements.annotationQuestions.classList.remove('hidden-by-skip');
                elements.skipReason.value = '';
            }

            // Scroll to top immediately
            window.scrollTo(0, 0);
        }

        function collectCurrentAnnotations() {
            const fields = [
                'emotion_anxiety_likert',
                'emotion_anger_likert',
                'emotion_sadness_likert',
                'emotion_joy_likert',
                'emotion_optimism_likert',
                'emotion_frustration_likert',
                'emotion_fear_likert',
                'emotion_hope_likert',
                'sentiment_categorical',
                'sentiment_likert',
                'mf_best',
                'mf_orientation',
                'political_guess'
            ];

            const annotations = {};
            
            fields.forEach(field => {
                // Check open-ended text inputs
                const textInput = document.getElementById(`${field}_input`);
                if (textInput) {
                    const val = textInput.value.trim();
                    if (val) annotations[field] = val;
                    return;
                }

                // Check radio buttons
                const radio = document.querySelector(`input[name="${field}"]:checked`);
                if (radio) {
                    annotations[field] = radio.value;
                    return;
                }

                // Check likert/yesno buttons
                const container = document.querySelector(`[data-field="${field}"]`);
                if (container) {
                    const selected = container.querySelector('.likert-btn.selected, .yesno-btn.selected');
                    if (selected) {
                        annotations[field] = selected.dataset.value;
                    }
                }
            });

            return annotations;
        }

        function validateAnnotations(annotations) {
            const required = [
                'emotion_anxiety_likert',
                'emotion_anger_likert',
                'emotion_sadness_likert',
                'emotion_joy_likert',
                'emotion_optimism_likert',
                'emotion_frustration_likert',
                'emotion_fear_likert',
                'emotion_hope_likert',
                'sentiment_categorical',
                'sentiment_likert',
                'mf_best',
                'mf_orientation',
                'political_guess'
            ];

            let valid = true;
            document.querySelectorAll('.question').forEach(q => q.classList.remove('error'));

            required.forEach(field => {
                if (!annotations[field]) {
                    const container = document.querySelector(`[data-field="${field}"]`);
                    if (container) {
                        container.classList.add('error');
                        valid = false;
                    }
                }
            });

            if (!valid) {
                showToast('Por favor, responda todas as perguntas');
                // Scroll to first error
                const firstError = document.querySelector('.question.error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            return valid;
        }

        async function saveCurrentAndNext() {
            const annotations = collectCurrentAnnotations();
            
            if (!validateAnnotations(annotations)) return;

            const item = state.data[state.currentIndex];
            const rowKey = getRowKey(item);
            state.annotations[rowKey] = annotations;
            await saveState();
            updateProgress();

            if (state.currentIndex < state.data.length - 1) {
                loadItem(state.currentIndex + 1);
            } else {
                // Check if all are complete
                if (Object.keys(state.annotations).length === state.data.length) {
                    state.isComplete = true;
                    await saveState();
                    showScreen('complete');
                } else {
                    showToast('Alguns itens ainda precisam de anota√ß√£o');
                    // Find first incomplete
                    for (let i = 0; i < state.data.length; i++) {
                        const key = getRowKey(state.data[i]);
                        if (!state.annotations[key]) {
                            loadItem(i);
                            break;
                        }
                    }
                }
            }
        }

        async function skipCurrentAndNext() {
            const reason = elements.skipReason.value;
            if (!reason) {
                showToast('Por favor, selecione um motivo para pular');
                elements.skipReason.focus();
                return;
            }

            // Build an annotation object with NA for every field
            const naFields = [
                'emotion_anxiety_likert', 'emotion_anger_likert',
                'emotion_sadness_likert', 'emotion_joy_likert',
                'emotion_optimism_likert', 'emotion_frustration_likert',
                'emotion_fear_likert', 'emotion_hope_likert',
                'sentiment_categorical', 'sentiment_likert',
                'mf_best', 'mf_orientation',
                'political_guess'
            ];
            const annotations = { _skipped: true, skip_reason: reason };
            naFields.forEach(f => annotations[f] = 'NA');

            const item = state.data[state.currentIndex];
            const rowKey = getRowKey(item);
            state.annotations[rowKey] = annotations;
            await saveState();
            updateProgress();

            if (state.currentIndex < state.data.length - 1) {
                loadItem(state.currentIndex + 1);
            } else {
                if (Object.keys(state.annotations).length === state.data.length) {
                    state.isComplete = true;
                    await saveState();
                    showScreen('complete');
                } else {
                    for (let i = 0; i < state.data.length; i++) {
                        const key = getRowKey(state.data[i]);
                        if (!state.annotations[key]) {
                            loadItem(i);
                            break;
                        }
                    }
                }
            }
        }

        function unskipCurrent() {
            const item = state.data[state.currentIndex];
            const rowKey = getRowKey(item);
            delete state.annotations[rowKey];
            updateProgress();
            loadItem(state.currentIndex);
        }

        function generateCSV() {
            const headers = [
                'rowid',
                'ResponseId',
                'statement',
                'X_describe',
                'annotator_id',
                'skip_reason',
                'emotion_anxiety_likert',
                'emotion_anger_likert',
                'emotion_sadness_likert',
                'emotion_joy_likert',
                'emotion_optimism_likert',
                'emotion_frustration_likert',
                'emotion_fear_likert',
                'emotion_hope_likert',
                'sentiment_categorical',
                'sentiment_likert',
                'mf_best',
                'mf_orientation',
                'political_guess'
            ];

            const rows = state.data.map(item => {
                const rowKey = getRowKey(item);
                const ann = state.annotations[rowKey] || {};
                return [
                    escapeCSV(item.rowid),
                    escapeCSV(item.ResponseId),
                    escapeCSV(item.statement),
                    escapeCSV(item.X_describe),
                    escapeCSV(state.annotatorId),
                    escapeCSV(ann.skip_reason || ''),
                    ann.emotion_anxiety_likert || '',
                    ann.emotion_anger_likert || '',
                    ann.emotion_sadness_likert || '',
                    ann.emotion_joy_likert || '',
                    ann.emotion_optimism_likert || '',
                    ann.emotion_frustration_likert || '',
                    ann.emotion_fear_likert || '',
                    ann.emotion_hope_likert || '',
                    ann.sentiment_categorical || '',
                    ann.sentiment_likert || '',
                    ann.mf_best || '',
                    ann.mf_orientation || '',
                    ann.political_guess || ''
                ].join(',');
            });

            return [headers.join(','), ...rows].join('\n');
        }

        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }

        function downloadCSV() {
            const csv = generateCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `annotations_${state.annotatorId}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ===== EVENT LISTENERS =====
        function initEventListeners() {
            // Username input - update filename preview
            elements.annotatorId.addEventListener('input', () => {
                const username = elements.annotatorId.value.trim();
                if (username) {
                    elements.filenamePreview.textContent = `annotations_${username}.csv`;
                } else {
                    elements.filenamePreview.textContent = 'annotations_[usuario].csv';
                }
                checkStartReady();
                
                // Check if user already has a file
                if (username) {
                    checkExistingUser(username);
                }
            });

            elements.startBtn.addEventListener('click', startAnnotation);
            elements.resumeBtn.addEventListener('click', resumeSession);

            // Confirmation dialog buttons
            elements.confirmCancel.addEventListener('click', () => {
                elements.confirmOverlay.classList.remove('show');
            });

            elements.confirmProceed.addEventListener('click', async () => {
                elements.confirmOverlay.classList.remove('show');
                const username = elements.confirmOverlay.dataset.username;
                await doStartFresh(username);
            });

            // Instructions panel toggle
            elements.instructionsBtn.addEventListener('click', () => {
                elements.instructionsPanel.classList.add('show');
            });

            elements.instructionsClose.addEventListener('click', () => {
                elements.instructionsPanel.classList.remove('show');
            });

            elements.instructionsPanel.addEventListener('click', (e) => {
                if (e.target === elements.instructionsPanel) {
                    elements.instructionsPanel.classList.remove('show');
                }
            });

            // Close instructions with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && elements.instructionsPanel.classList.contains('show')) {
                    elements.instructionsPanel.classList.remove('show');
                }
            });

            // Navigation
            elements.prevBtn.addEventListener('click', async () => {
                if (state.currentIndex > 0) {
                    // Save current before moving (partial save OK)
                    const annotations = collectCurrentAnnotations();
                    if (Object.keys(annotations).length > 0) {
                        const item = state.data[state.currentIndex];
                        const rowKey = getRowKey(item);
                        state.annotations[rowKey] = annotations;
                        await saveState();
                        updateProgress();
                    }
                    loadItem(state.currentIndex - 1);
                }
            });

            elements.nextBtn.addEventListener('click', saveCurrentAndNext);

            elements.downloadBtn.addEventListener('click', downloadCSV);
            
            elements.reviewBtn.addEventListener('click', () => {
                showScreen('annotation');
                loadItem(0);
            });

            // Jump to specific item
            elements.jumpBtn.addEventListener('click', async () => {
                const target = parseInt(elements.jumpInput.value);
                if (target >= 1 && target <= state.data.length) {
                    // Save current first
                    const annotations = collectCurrentAnnotations();
                    if (Object.keys(annotations).length > 0) {
                        const item = state.data[state.currentIndex];
                        const rowKey = getRowKey(item);
                        state.annotations[rowKey] = annotations;
                        await saveState();
                        updateProgress();
                    }
                    loadItem(target - 1);
                }
            });

            elements.jumpInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    elements.jumpBtn.click();
                }
            });

            // Skip controls
            elements.skipBtn.addEventListener('click', skipCurrentAndNext);
            elements.unskipBtn.addEventListener('click', unskipCurrent);

            // Open-ended text inputs - clear error on typing
            document.querySelectorAll('.open-ended-input').forEach(input => {
                input.addEventListener('input', () => {
                    input.closest('.question')?.classList.remove('error');
                });
            });

            // Option buttons (radio style)
            document.querySelectorAll('.options-grid .option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const group = btn.closest('.options-grid');
                    group.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    btn.querySelector('input').checked = true;
                    btn.closest('.question')?.classList.remove('error');
                });
            });

            // Likert buttons
            document.querySelectorAll('.likert-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const scale = btn.closest('.likert-scale');
                    scale.querySelectorAll('.likert-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    btn.closest('.question')?.classList.remove('error');
                });
            });

            // Yes/No buttons
            document.querySelectorAll('.yesno-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const container = btn.closest('.yesno-container');
                    container.querySelectorAll('.yesno-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    btn.closest('.question')?.classList.remove('error');
                });
            });

        }

        async function checkExistingUser(username) {
            const result = await apiCheckUser(username);
            let hasExistingSession = false;
            let completedCount = 0;
            let totalCount = state.data.length;

            if (result && result.exists) {
                hasExistingSession = true;
                // Try to get completion count from server
                const serverData = await apiLoadUserAnnotations(username);
                if (serverData && serverData.annotations) {
                    completedCount = Object.keys(serverData.annotations).length;
                }
            } else {
                // Check localStorage too
                const saved = loadState();
                if (saved && saved.annotatorId === username && saved.data.length > 0) {
                    hasExistingSession = true;
                    completedCount = Object.keys(saved.annotations).length;
                    totalCount = saved.data.length;
                }
            }

            if (hasExistingSession) {
                // Show resume button as primary (green), start as secondary (beige)
                elements.resumeBtn.style.display = 'block';
                elements.resumeBtn.textContent = `Retomar Sess√£o (${completedCount}/${totalCount} completos)`;
                elements.resumeBtn.className = 'btn btn-primary btn-large';
                elements.startBtn.className = 'btn btn-secondary';
                elements.startBtn.textContent = 'Come√ßar do Zero (apaga progresso)';
            } else {
                // Hide resume, show start as primary
                elements.resumeBtn.style.display = 'none';
                elements.startBtn.className = 'btn btn-primary';
                elements.startBtn.textContent = 'Come√ßar a Anotar';
            }
        }

        function checkStartReady() {
            const hasAnnotator = elements.annotatorId.value.trim().length > 0;
            const hasData = state.data.length > 0;
            elements.startBtn.disabled = !(hasAnnotator && hasData);
        }

        async function startAnnotation() {
            const username = elements.annotatorId.value.trim();

            // Check if a file already exists on the server -- guard against accidental overwrite
            if (state.serverMode) {
                const check = await apiCheckUser(username);
                if (check && check.exists) {
                    // Show confirmation dialog instead of proceeding immediately
                    showConfirmFresh(username);
                    return;
                }
            }

            // No existing file -- proceed normally
            await doStartFresh(username);
        }

        function showConfirmFresh(username) {
            elements.confirmOverlay.classList.add('show');
            // Store the username so the confirm handler can use it
            elements.confirmOverlay.dataset.username = username;
        }

        async function doStartFresh(username) {
            state.annotatorId = username;
            state.annotations = {};
            state.currentIndex = 0;
            state.isComplete = false;

            // Initialize user file on server
            if (state.serverMode) {
                const result = await apiInitUser(state.annotatorId);
                if (result && result.created) {
                    showToast(`Arquivo annotations_${state.annotatorId}.csv criado`);
                }
            }

            elements.annotatorDisplay.textContent = state.annotatorId;
            await saveState();
            updateProgress();
            showScreen('annotation');
            loadItem(0);
        }

        async function resumeSession() {
            const username = elements.annotatorId.value.trim();
            
            // First try to load from server
            if (state.serverMode && username) {
                const serverData = await apiLoadUserAnnotations(username);
                if (serverData && serverData.exists) {
                    // Load template data
                    const templateResult = await apiLoadTemplate();
                    if (templateResult && templateResult.data) {
                        state.data = templateResult.data;
                        state.annotations = serverData.annotations || {};
                        // Reconstruct _skipped flag for rows that have a skip_reason
                        Object.values(state.annotations).forEach(ann => {
                            if (ann.skip_reason) ann._skipped = true;
                        });
                        state.annotatorId = username;
                        state.currentIndex = findFirstIncomplete();
                        state.isComplete = Object.keys(state.annotations).length === state.data.length;
                        
                        elements.annotatorDisplay.textContent = state.annotatorId;
                        updateProgress();
                        
                        if (state.isComplete) {
                            showScreen('complete');
                        } else {
                            showScreen('annotation');
                            loadItem(state.currentIndex);
                        }
                        return;
                    }
                }
            }
            
            // Fallback to localStorage
            const saved = loadState();
            if (saved) {
                state = saved;
                elements.annotatorDisplay.textContent = state.annotatorId;
                updateProgress();
                
                if (state.isComplete) {
                    showScreen('complete');
                } else {
                    showScreen('annotation');
                    loadItem(state.currentIndex);
                }
            }
        }

        function findFirstIncomplete() {
            for (let i = 0; i < state.data.length; i++) {
                const key = getRowKey(state.data[i]);
                if (!state.annotations[key]) {
                    return i;
                }
            }
            return 0;
        }

        // ===== INIT =====
        async function init() {
            initEventListeners();

            // Try to load data from server
            elements.loadingStatus.textContent = 'Carregando dados do servidor...';
            
            try {
                const result = await apiLoadTemplate();
                if (result && result.data && result.data.length > 0) {
                    state.data = result.data;
                    state.serverMode = true;
                    elements.loadingStatus.innerHTML = `‚úì <strong>${result.count} itens</strong> carregados de annotations_empty.csv`;
                    elements.dataStatus.style.background = 'var(--accent-light)';
                    checkStartReady();
                } else {
                    state.serverMode = false;
                    elements.loadingStatus.innerHTML = `
                        <span style="color: #c45a5a;">‚ö†Ô∏è Servidor n√£o est√° rodando</span><br>
                        <small>Inicie o servidor com: <code>python server.py</code></small>
                    `;
                }
            } catch (e) {
                state.serverMode = false;
                elements.loadingStatus.innerHTML = `
                    <span style="color: #c45a5a;">‚ö†Ô∏è N√£o foi poss√≠vel conectar ao servidor</span><br>
                    <small>Inicie o servidor com: <code>python server.py</code></small>
                `;
            }

            // Check for existing sessions on the server (protects against cleared cache)
            if (state.serverMode) {
                const usersResult = await apiListUsers();
                if (usersResult && usersResult.users && usersResult.users.length > 0) {
                    displayExistingSessions(usersResult.users);
                }
            }

            // Check for existing session in localStorage
            const saved = loadState();
            if (saved && saved.data && saved.data.length > 0) {
                elements.annotatorId.value = saved.annotatorId || '';
                if (saved.annotatorId) {
                    elements.filenamePreview.textContent = `annotations_${saved.annotatorId}.csv`;
                    // Trigger the existing user check to set up buttons properly
                    checkExistingUser(saved.annotatorId);
                    checkStartReady();
                }
            }
        }

        function displayExistingSessions(users) {
            elements.existingSessions.style.display = 'block';
            elements.sessionsList.innerHTML = '';

            users.forEach(user => {
                const card = document.createElement('div');
                card.className = 'session-card';
                const pct = user.total > 0 ? Math.round((user.completed / user.total) * 100) : 0;
                card.innerHTML = `
                    <div class="session-info">
                        <div class="session-username">${escapeHTML(user.username)}</div>
                        <div class="session-progress">${user.completed} / ${user.total} completos (${pct}%)</div>
                    </div>
                    <div class="session-resume-label">Clique para retomar ‚Üí</div>
                `;
                card.addEventListener('click', () => {
                    elements.annotatorId.value = user.username;
                    elements.filenamePreview.textContent = `annotations_${user.username}.csv`;
                    checkExistingUser(user.username);
                    checkStartReady();
                    // Scroll down to the buttons
                    elements.buttonContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                elements.sessionsList.appendChild(card);
            });
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        init();
    </script>
</body>
</html>
